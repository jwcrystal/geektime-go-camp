# 優雅退出

## 需求

- 功能性需求

| **功能點**     | **描述**                                                     |
| -------------- | ------------------------------------------------------------ |
| 監聽退出信號   | 應用能夠監聽系統信號，在收到信號的執行優雅退出。需要考慮的操作系統有： •	Windows •	Mac OS •	Linux |
| 強制退出       | 應用監聽系統信號，在第一次收到信號的時候執行優雅退出。如果退出期間再次收到信號，則直接退出，並且輸出強制退出的日誌 |
| 超時強制退出   | 當應用在優雅退出的過程中，如果超出了時間限制，那麼直接強制退出。 開發者可以配置該超時時間 |
| 拒絕新請求     | 應用在優雅退出的時候，拒絕掉新請求                           |
| 等待已接收請求 | 應用需要等待一段時間，等待已經接收、正在處理的請求執行完畢。等待時間應該可配置的。 如果在等待期間，就觸發了強制退出，那麼應用會放棄等待，直接退出。 |
| 釋放資源       | 應用釋放自身持有的資源                                       |
| 註冊回調接口   | 開發者可以註冊自定義回調，目前只支持在應用等待當前請求執行完畢，釋放應用持有資源之前，執行開發者註冊的回調。 回調應該是獨立的，開發者需要自己確保回調之間沒有任何依賴。 |

- 非功能需求
  - 支援跨平台： Windows, Mac OS, Linux
```go
var signals = []os.Signal{
	os.Interrupt, os.Kill, syscall.SIGKILL, syscall.SIGSTOP,
	syscall.SIGHUP, syscall.SIGINT, syscall.SIGQUIT, syscall.SIGILL, syscall.SIGTRAP,
	syscall.SIGABRT, syscall.SIGSYS, syscall.SIGTERM,
}
```

## 思考方向

- **接到中斷訊號後，會拒絕所有新請求**，等待正在執行的請求結束，才會關閉服務
- 如果等待超時，會直接強制中斷，所以我們可以**註冊一個回調機制，在接收到中斷訊號時候，開始刷新緩存到落盤，避免資料遺失**
- 這邊關閉回調沒有特殊設計，所以只要確認併發回調不會互相影響即可
  ```go
  for _, srv := range app.servers {
      // 本身是 http.ServeMux 的對象
      // 而且又用了裝飾器模式封裝成新對象，所以控制是獨立的對象本身
      // 只要自身關閉即可
      srv.rejectReq()
  }
  // 在 ServeHTTP 方法中，會判斷一個 reject 標記
  // 故接收到關閉訊號，就無法接收新服務
  if s.reject {
		w.WriteHeader(http.StatusServiceUnavailable)
		_, _ = w.Write([]byte("服务已关闭"))
		return
  }
  // 併發執行回調
  	wg.Add(len(app.servers))
	for _, cb := range app.cbs {
		c := cb
		go func() {
			defer wg.Done()
			ctxTO, cancel := context.WithTimeout(context.Background(), app.cbTimeout)
			defer cancel()
			c(ctxTO)
		}()
	}
	wg.Wait()
  ```
- 

## 執行方式

- 採用終端機下指令執行，用 IDE 可能會遇到訊號攔截問題
```shell
$ go run main.go
```
## DEMO
```shell
╰─ go run main.go       

# ^C 為 Ctrl + C 的中斷訊號(os.Interrupt = syscall.SIGINT)
# 接收到 2 次中斷直接強制退出
2023/01/15 17:19:43 Server 啟動
^C2023/01/15 17:19:44 开始关闭应用，停止接收新请求
2023/01/15 17:19:44 等待正在执行请求完结
^C2023/01/15 17:19:45 強制退出
exit status 1


# 超時強制退出, 緩存落盤成功
2023/01/15 17:19:49 Server 啟動
^C2023/01/15 17:19:50 开始关闭应用，停止接收新请求
2023/01/15 17:19:50 等待正在执行请求完结
2023/01/15 17:19:55 开始关闭服务器
2023/01/15 17:19:55 服务器admin关闭中
2023/01/15 17:19:55 服务器admin已关闭
2023/01/15 17:19:55 服务器business关闭中
2023/01/15 17:19:55 服务器business已关闭
2023/01/15 17:19:55 开始执行自定义回调
2023/01/15 17:19:55 刷新缓存中……
2023/01/15 17:19:56 缓存被刷新到了 DB
2023/01/15 17:19:58 超時強制退出
exit status 1

# 超時強制退出, 緩存落盤失敗
# 假設 回調超時 3 秒，但落盤時間 5 秒
2023/01/15 17:28:41 Server 啟動
^C2023/01/15 17:28:41 开始关闭应用，停止接收新请求
2023/01/15 17:28:41 等待正在执行请求完结
2023/01/15 17:28:46 开始关闭服务器
2023/01/15 17:28:46 服务器admin关闭中
2023/01/15 17:28:46 服务器business关闭中
2023/01/15 17:28:46 服务器admin已关闭
2023/01/15 17:28:46 服务器business已关闭
2023/01/15 17:28:46 开始执行自定义回调
2023/01/15 17:28:46 刷新缓存中……
2023/01/15 17:28:49 刷新缓存超时
2023/01/15 17:28:49 超時強制退出
exit status 1

```